{% extends 'base.html' %} {% block content %}
<h2>LanÃ§ar Pagamento{% if cliente %} - {{ cliente.nome }}{% endif %}</h2>

<form method="post" id="pagamentoForm">
  <label>DÃ­vida:</label><br />
  <select name="divida_id" id="dividaSelect" required onchange="atualizarParcelas()">
    <option value="">Selecione uma dÃ­vida</option>
    {% for d in dividas %}
    <option value="{{ d.id }}" 
            data-parcelado="{{ d.get('parcelado', False) }}" 
            data-parcelas='{{ d.get("parcelas", []) | tojson }}'>
      {{ d.descricao }} (Restante: R$ {{ "%.2f"|format(d.saldo_devedor) }})
    </option>
    {% endfor %}
  </select>
  <br /><br />

  <div id="infoParcelamento" style="display: none; background: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
    <h3 style="margin-top: 0;">ðŸ“‹ PrÃ³xima Parcela</h3>
    <div id="detalheParcela"></div>
    <input type="hidden" name="parcela_id" id="parcelaId" />
  </div>

  <label>Valor do Pagamento:</label><br />
  <input type="number" step="0.01" name="valor" id="valorInput" required />
  <br /><br />

  <label>Meio de Pagamento:</label><br />
  <select name="meio">
    <option value="Dinheiro">Dinheiro</option>
    <option value="Pix">Pix</option>
    <option value="CartÃ£o">CartÃ£o</option>
    <option value="Boleto">Boleto</option>
  </select>
  <br /><br />

  <input type="hidden" name="usuario" value="{{ session.get('user_nome') }}" />
  <button class="btn" type="submit">Registrar Pagamento</button>
  <a href="{{ url_for('main.home') }}" class="btn ghost">Cancelar</a>
</form>

<script>
function atualizarParcelas() {
  const select = document.getElementById('dividaSelect');
  const option = select.options[select.selectedIndex];
  const parceladoAttr = option.getAttribute('data-parcelado');
  const parcelado = parceladoAttr === 'True' || parceladoAttr === 'true';
  const infoDiv = document.getElementById('infoParcelamento');
  const detalheDiv = document.getElementById('detalheParcela');
  const valorInput = document.getElementById('valorInput');
  const parcelaIdInput = document.getElementById('parcelaId');
  
  if (parcelado && option.value) {
    const parcelas = JSON.parse(option.getAttribute('data-parcelas') || '[]');
    
    const proximaParcela = parcelas.find(p => {
      const valorRestante = p.valor_parcela - p.valor_pago;
      return valorRestante > 0.01 && (p.status === 'Pendente' || p.status === 'Vencida');
    });
    
    if (proximaParcela) {
      const valorRestante = proximaParcela.valor_parcela - proximaParcela.valor_pago;
      const dataVenc = new Date(proximaParcela.data_vencimento);
      const statusClass = proximaParcela.status === 'Vencida' ? 'style="color: red;"' : '';
      
      detalheDiv.innerHTML = `
        <p><strong>Parcela ${proximaParcela.numero}</strong></p>
        <p>Valor: <strong>R$ ${proximaParcela.valor_parcela.toFixed(2)}</strong></p>
        <p>JÃ¡ pago: R$ ${proximaParcela.valor_pago.toFixed(2)}</p>
        <p>Restante: <strong>R$ ${valorRestante.toFixed(2)}</strong></p>
        <p>Vencimento: ${dataVenc.toLocaleDateString('pt-BR')}</p>
        <p ${statusClass}>Status: ${proximaParcela.status}</p>
      `;
      
      valorInput.value = valorRestante.toFixed(2);
      valorInput.removeAttribute('max');
      parcelaIdInput.value = proximaParcela.id;
      
      infoDiv.style.display = 'block';
    } else {
      detalheDiv.innerHTML = '<p style="color: green;">âœ… Todas as parcelas foram pagas!</p>';
      infoDiv.style.display = 'block';
      valorInput.value = '';
      valorInput.removeAttribute('max');
      parcelaIdInput.value = '';
    }
  } else {
    infoDiv.style.display = 'none';
    valorInput.value = '';
    valorInput.removeAttribute('max');
    parcelaIdInput.value = '';
  }
}
</script>
{% endblock %}
